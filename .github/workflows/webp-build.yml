name: Generate WebP thumbnails

on:
  workflow_dispatch:          # ★ 버튼 실행용 트리거
    inputs:
      quality:
        description: "WebP quality (0-100, default 80)"
        required: false
        default: "80"

  push:
    paths: [ "images/**.png", "images/**.jpg", "images/**.jpeg" ]
  pull_request:
    paths: [ "images/**.png", "images/**.jpg", "images/**.jpeg" ]

jobs:
  webp:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install cwebp
        run: sudo apt-get update && sudo apt-get install -y webp

      - name: Convert images
        shell: bash
        run: |
          mkdir -p images/webp
          Q=${{ github.event.inputs.quality || '80' }}
          echo "Quality: $Q"

          # 새로 추가·변경된 파일 목록 없으면 전체 변환
          FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} -- "images/*.png" "images/*.jpg" "images/*.jpeg")
          [[ -z "$FILES" ]] && FILES=$(ls images/*.{png,jpg,jpeg} 2>/dev/null || true)

          for f in $FILES; do
            base=$(basename "$f")
            out="images/webp/${base%.*}.webp"
            echo "▶︎ $f → $out"
            cwebp -q $Q "$f" -o "$out"
          done

      - name: Commit WebP files
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore(images): generate WebP via manual run"
