name: Generate WebP thumbnails

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ì–¸ì œ ì‹¤í–‰í•˜ë‚˜?
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
on:
  # 1) Actions íƒ­ â†’ Run workflow ë²„íŠ¼
  workflow_dispatch:
    inputs:
      quality:
        description: "WebP quality (0â€“100, default 80)"
        required: false
        default: "80"

  # 2) ì´ë¯¸ì§€ê°€ í¬í•¨ëœ ì»¤ë°‹ì´ push ë˜ë©´
  push:
    paths:
      - "images/**.png"
      - "images/**.jpg"
      - "images/**.jpeg"

  # 3) PR ì— ì´ë¯¸ì§€ê°€ ì¶”ê°€ë˜ë©´
  pull_request:
    paths:
      - "images/**.png"
      - "images/**.jpg"
      - "images/**.jpeg"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ì‘ì—… ì •ì˜
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
jobs:
  webp:
    runs-on: ubuntu-latest

    steps:
      # 1) ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
      - uses: actions/checkout@v4

      # 2) WebP CLI ì„¤ì¹˜
      - name: Install cwebp
        run: sudo apt-get update && sudo apt-get install -y webp

      # 3) ì´ë¯¸ì§€ ë³€í™˜
      - name: Convert images to WebP
        shell: bash
        run: |
          set -e
          mkdir -p images/webp
          Q=${{ github.event.inputs.quality || '80' }}
          echo "ğŸ”§ Quality = $Q"
      
          convert() {
            while IFS= read -r -d '' f; do
              [[ -z "$f" ]] && continue
              base=$(basename "$f")
              out="images/webp/${base%.*}.webp"
              echo "â–¶ï¸ $f â†’ $out"
              cwebp -quiet -q "$Q" "$f" -o "$out"
            done
          }
      
          # 1) ë³€ê²½ëœ ì´ë¯¸ì§€ (ìˆìœ¼ë©´ ì´ê²ƒë§Œ)
          if git diff --name-only -z ${{ github.event.before }} ${{ github.sha }} -- \
               "images/*.png" "images/*.jpg" "images/*.jpeg" | grep -q .; then
            git diff --name-only -z ${{ github.event.before }} ${{ github.sha }} -- \
              "images/*.png" "images/*.jpg" "images/*.jpeg" \
              | convert
          else
            # 2) ì—†ìœ¼ë©´ images/ ì „ì²´ ìŠ¤ìº”
            find images -maxdepth 1 -type f \( -iname '*.png' -o -iname '*.jpg' -o -iname '*.jpeg' \) -print0 \
              | convert
          fi


      # 4) ê²°ê³¼ ì»¤ë°‹ & í‘¸ì‹œ
      - name: Commit WebP files
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore(images): auto-generate WebP"
