name: Generate WebP thumbnails

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ì–¸ì œ ì‹¤í–‰í•˜ë‚˜?
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
on:
  # 1) Actions íƒ­ â†’ Run workflow ë²„íŠ¼
  workflow_dispatch:
    inputs:
      quality:
        description: "WebP quality (0â€“100, default 80)"
        required: false
        default: "80"

  # 2) ì´ë¯¸ì§€ê°€ í¬í•¨ëœ ì»¤ë°‹ì´ push ë˜ë©´
  push:
    paths:
      - "images/**.png"
      - "images/**.jpg"
      - "images/**.jpeg"

  # 3) PR ì— ì´ë¯¸ì§€ê°€ ì¶”ê°€ë˜ë©´
  pull_request:
    paths:
      - "images/**.png"
      - "images/**.jpg"
      - "images/**.jpeg"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ì‘ì—… ì •ì˜
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
jobs:
  webp:
    runs-on: ubuntu-latest

    steps:
      # 1) ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
      - uses: actions/checkout@v4

      # 2) WebP CLI ì„¤ì¹˜
      - name: Install cwebp
        run: sudo apt-get update && sudo apt-get install -y webp

      # 3) ì´ë¯¸ì§€ ë³€í™˜
      - name: Convert images to WebP
        shell: bash
        run: |
          set -e
          mkdir -p images/webp
          Q=${{ github.event.inputs.quality || '80' }}
          echo "ğŸ”§ Quality = $Q"

          # ë³€ê²½ëœ ì´ë¯¸ì§€ ëª©ë¡(ë„ êµ¬ë¶„). ì—†ì„ ë• ì „ì²´ ëŒ€ìƒ.
          FILES=$(git diff -z --name-only ${{ github.event.before }} ${{ github.sha }} -- \
                  "images/*.png" "images/*.jpg" "images/*.jpeg")
          if [[ -z "$FILES" ]]; then
            FILES=$(find images -maxdepth 1 -type f \( -iname '*.png' -o -iname '*.jpg' -o -iname '*.jpeg' \) -print0)
          fi

          # ë„(\0) ë‹¨ìœ„ë¡œ ì•ˆì „ ë£¨í”„
          while IFS= read -r -d '' f; do
            [[ -z "$f" ]] && continue
            base=$(basename "$f")
            out="images/webp/${base%.*}.webp"
            echo "â–¶ï¸ $f â†’ $out"
            cwebp -q "$Q" "$f" -o "$out"
          done < <(printf '%s' "$FILES")

      # 4) ê²°ê³¼ ì»¤ë°‹ & í‘¸ì‹œ
      - name: Commit WebP files
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore(images): auto-generate WebP"
