name: Generate Thumbnails

# â‘  GITHUB_TOKENìœ¼ë¡œ repoì— ì“°ê¸° ê¶Œí•œ ë¶€ì—¬
permissions:
  contents: write

on:
  push:
    paths:
      - 'images/*.{jpg,jpeg,png}'
  workflow_dispatch:

jobs:
  thumb:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
        with:
          persist-credentials: true     # â‘¡ í† í° ìœ ì§€

      - uses: actions/setup-node@v3
        with:
          node-version: '18'

      - run: npm install sharp

      - name: Resize to thumbnails
        run: |
          node <<'EOF'
          const fs    = require('fs');
          const path  = require('path');
          const sharp = require('sharp');

          (async () => {
            const SRC = 'images';
            const OUT = path.join(SRC, 'thumbs');
            if (!fs.existsSync(OUT)) fs.mkdirSync(OUT);

            const files = fs.readdirSync(SRC).filter(f=>/\.(jpe?g|png)$/i.test(f));
            for (const f of files) {
              const inp = path.join(SRC, f);
              const out = path.join(OUT, f);
              if (fs.existsSync(out)) continue;
              await sharp(inp).resize({ width: 600 }).toFile(out);
              console.log(`ğŸ”§ thumb: ${f}`);
            }
          })().catch(err => {
            console.error(err);
            process.exit(1);
          });
          EOF

      - name: Commit thumbs
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add images/thumbs
          git commit -m "chore: update thumbnails" || echo "No changes"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
