# .github/workflows/thumbnailer.yml
name: Generate Thumbnails

on:
  push:
    paths:
      - 'images/*.{jpg,jpeg,png}'   # ì›ë³¸ ì´ë¯¸ì§€ê°€ ë°”ë€” ë•Œë§ˆë‹¤
  workflow_dispatch:               # ìˆ˜ë™ ì‹¤í–‰ ì˜µì…˜

jobs:
  thumb:
    runs-on: ubuntu-latest
    steps:
      # 1) ì†ŒìŠ¤ ì²´í¬ì•„ì›ƒ
      - uses: actions/checkout@v3

      # 2) Node.js ì„¸íŒ… (Sharp ì‚¬ìš©)
      - uses: actions/setup-node@v3
        with: { node-version: '18' }

      # 3) sharp ì„¤ì¹˜
      - run: npm install sharp

      # 4) ì¸ë„¤ì¼ ìƒì„± ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
      - name: Resize to thumbnails
        run: |
          node <<'EOF'
          const fs    = require('fs');
          const path  = require('path');
          const sharp = require('sharp');

          (async () => {
            const SRC = 'images';
            const OUT = path.join(SRC, 'thumbs');
            if (!fs.existsSync(OUT)) fs.mkdirSync(OUT);

            const files = fs.readdirSync(SRC)
              .filter(f => /\.(jpe?g|png)$/i.test(f));
            for (const f of files) {
              const inp = path.join(SRC, f);
              const out = path.join(OUT, f);
              if (fs.existsSync(out)) continue;
              await sharp(inp)
                .resize({ width: 200 })
                .toFile(out);
              console.log(`ğŸ”§ thumb: ${f}`);
            }
          })().catch(err => {
            console.error(err);
            process.exit(1);
          });
          EOF


      # 5) ì»¤ë°‹ & í‘¸ì‹œ
      - name: Commit thumbs
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add images/thumbs
          git commit -m "chore: update thumbnails" || echo "No thumbnail changes"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
